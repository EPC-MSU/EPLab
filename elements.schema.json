{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "hg://hg.ximc.ru/eyepoint/elements.schema.json",
  "title": "EPLab PCB file format",
  "description": "This schema describes the EPLab files format for PCB components description. There is an additional data in the saves, but this only describes one main json file",
  "additionalProperties": false,
  "type": "object",
  "properties": {
    "elements": {
      "description": "Array of elements, each of them represents a component on the PCB.",
      "minItems": 1,
      "uniqueItems": true,
      "type": "array",
      "items": {
        "description": "Component on the PCB. May be a integrated circuit or SMD chip. Sometimes a nonexistent component is created just to place testing points inside it. Each board should contain at least one component, real or faked. So basically component provides convinient wrapper for pins.",
        "additionalProperties": false,
        "type": "object",
        "properties": {
          "name": {
            "description": "Is set when component was recognized by automated system and set one of the supported names.",
            "type": "string"
          },
          "is_manual": {
            "description": "Is set when component was added manually and not with automated recognition of supported components. Otherwise it is false.",
            "type": "boolean"
          },
          "pins": {
            "description": "An array of testable pins of the PCB component. Pins are simple because they are just one point on the map, but they contain electrical data. Each component must have at least one pin to be meaningful.",
            "uniqueItems": true,
            "minItems": 1,
            "type": "array",
            "items": {
              "description": "A pin for electrical test.",
              "additionalProperties": false,
              "type": "object",
              "properties": {
                "cluster_id": {
                  "description": "Must be used when multiple measurements will be available for one pin. It's not true for now.",
                  "minimum": -1,
                  "maximum": -1,
                  "type": "integer"
                },
                "comment": {
                  "description": "Pin comment",
                  "type": "string"
                },
                "y": {
                  "description": "Y coordinate of the pin on the board image [pixels]",
                  "type": "number"
                },
                "x": {
                  "description": "X coordinate of the pin on the board image [pixels]",
                  "type": "number"
                },
                "is_dynamic": {
                  "description": "The electrical measurement can reveal that it differs from time to time. This is called dynamic ivc and marked with this flag.",
                  "type": "boolean"
                },
                "reference_ivc": {
                  "anyOf": [
                    {
                      "type": "null"
                    },
                    {
                      "type": "object",
                      "properties": {
                        "measure_settings": {
                          "additionalProperties": false,
                          "type": "object",
                          "properties": {
                            "probe_signal_frequency": {
                              "description": "Harmonic probe signal frequency. Units: Hz. Normally this parameter is set together with sampling rate for providing fixed resolution.",
                              "type": "number"
                            },
                            "max_voltage": {
                              "description": "Harmonic probe signal voltage amplitude. Units: Volts. This is open circuit voltage. Real voltage drop between probes during the measurement will be smaller due to finite current sensor impedance.",
                              "type": "number"
                            },
                            "max_current": {
                              "description": "Maximum short circuit current. Units: mA. This parameter may not be supported by the most devices.",
                              "type": "number"
                            },
                            "n_charge_points": {
                              "description": "This parameter determines delay added for testing component precharge before measurement. This parameter is set as number of samples. The value of the delay in seconds can be calculated as NumberChargePoints ∗ SamplingRate. These precharge points are not presented in measurement results. Warning: some devices don’t support precharge.",
                              "type": "integer"
                            },
                            "desc_frequency": {
                              "description": "This rate determines the period between subsequent samples in measured curve. Units: samples / second. Normally this parameter is set together with probe signal frequency for providing fixed resolution, which is determined by the SamplingRate / ProbeSignalFrequency ratio.",
                              "type": "number"
                            },
                            "flags": {
                              "description": "Flags for current sensor mode definition. Current sensor modes define resolution and noise level. Current sense resistors also limit the maximum current. See hardware manual for more detailed description of mode values for this parameter.",
                              "type": "integer"
                            }
                          },
                          "required": [
                            "desc_frequency",
                            "flags",
                            "max_current",
                            "max_voltage",
                            "probe_signal_frequency",
                            "n_charge_points"
                          ]
                        },
                        "voltage": {
                          "description": "Measured voltages [V] in dependence with time.",
                          "type": "array",
                          "items": {
                            "type": "number"
                          }
                        },
                        "current": {
                          "description": "Measured currents [A] in dependence with time.",
                          "type": "array",
                          "items": {
                            "type": "number"
                          }
                        }
                      },
                      "required": [
                        "current",
                        "measure_settings",
                        "voltage"
                      ]
                    }
                  ]
                }
              },
              "patternProperties": {
                "ivc$": { 
                  "description": "IV curve measuremnt: device settings and measurement results. ivc – basic measurement. Additionally in reference_ivc filed reference data could be stored.",
                  "anyOf": [
                    {
                      "description": "May be null when was renamed to reference_ivc.",
                      "type": "null"
                    },
                    {
                      "description": "Each measurement consists of voltages, currents (the iv curve) and measurement details.",
                      "additionalProperties": false,
                      "type": "object",
                      "properties": {
                        "measure_settings": {
                          "description": "The measurement details.",
                          "additionalProperties": false,
                          "type": "object",
                          "properties": {
                            "probe_signal_frequency": {
                              "description": "Harmonic probe signal frequency. Units: Hz. Normally this parameter is set together with sampling rate for providing fixed resolution.",
                              "type": "number"
                            },
                            "max_voltage": {
                              "description": "Harmonic probe signal voltage amplitude. Units: Volts. This is open circuit voltage. Real voltage drop between probes during the measurement will be smaller due to finite current sensor impedance.",
                              "type": "number"
                            },
                            "max_current": {
                              "description": "Maximum short circuit current. Units: mA. This parameter may not be supported by the most devices.",
                              "type": "number"
                            },
                            "n_charge_points": {
                              "description": "This parameter determines delay added for testing component precharge before measurement. This parameter is set as number of samples. The value of the delay in seconds can be calculated as NumberChargePoints ∗ SamplingRate. These precharge points are not presented in measurement results. Warning: some devices don’t support precharge.",
                              "type": "integer"
                            },
                            "desc_frequency": {
                              "description": "This rate determines the period between subsequent samples in measured curve. Units: samples / second. Normally this parameter is set together with probe signal frequency for providing fixed resolution, which is determined by the SamplingRate / ProbeSignalFrequency ratio.",
                              "type": "number"
                            },
                            "flags": {
                              "description": "Flags for current sensor mode definition. Current sensor modes define resolution and noise level. Current sense resistors also limit the maximum current. See hardware manual for more detailed description of mode values for this parameter.",
                              "type": "integer"
                            }
                          },
                          "required": [
                            "desc_frequency",
                            "flags",
                            "max_current",
                            "max_voltage",
                            "probe_signal_frequency",
                            "n_charge_points"
                          ]
                        },
                        "voltage": {
                          "description": "Measured voltages [V] in dependence with time.",
                          "minItems": 2,
                          "type": "array",
                          "items": {
                            "type": "number"
                          }
                        },
                        "current": {
                          "description": "Measured currents [A] in dependence with time.",
                          "minItems": 2,
                          "type": "array",
                          "items": {
                            "type": "number"
                          }
                        }
                      },
                      "required": [
                        "current",
                        "measure_settings",
                        "voltage"
                      ]
                    }
                  ]
                }
              },
              "required": [
                "cluster_id",
                "is_dynamic",
                "ivc",
                "reference_ivc",
                "x",
                "y"
              ]
            }
          },
          "center": {
            "description": "Defines 2D coordinates for component center [pixels]. First x, then y.",
            "type": "array",
            "minItems": 2,
            "maxItems": 2,
            "items": {
              "type": "number"
            }
          },
          "bounding_zone": {
            "description": "TODO: please rewrite whole block with some understanding.",
            "anyOf": [
              {
                "description": "bounding_zone is an empty array when not used.",
                "maxItems": 0,
                "type": "array"
              },
              {
                "description": "bounding_zone is an array with 4 or 12 vertixes when used.",
                "minItems": 4,
                "maxItems": 12,
                "type": "array",
                "items": {
                  "description": "A 2D coordinates of ...",
                  "type": "array",
                  "items": {
                    "type": "number"
                  }
                }
              }
            ]
          },
          "rotation": {
            "description": "Each automatically recognized PCB component can be placed on the board in 4 different rotations - each one by additionl 90 degrees from the original. This parameter is reqired for correct placement of component and its picture.",
            "minimum": 0,
            "maximum": 3,
            "type": "integer"
          },
          "width": {
            "description": "Component width in px (measured by marginal pins).",
            "type": "number"
          },
          "height": {
            "description": "Component height in px (measured by marginal pins).",
            "type": "number"
          }
        },
        "required": [
          "bounding_zone",
          "center",
          "height",
          "rotation",
          "width",
          "name",
          "pins"
        ]
      }
    },
    "version": {
      "description": "Protocol version",
      "type": "string"
    }
  },
  "required": [
    "elements",
    "version"
  ]
}
