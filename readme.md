# EPLab

Программное обеспечение для работы с устройствами линейки EyePoint, предназначенными для поиска неисправностей на печатных платах в ручном режиме (при помощи ручных щупов).

## Установка в Windows

1. Установить MSVC 2013 redistributable и MSVC 2015 redistributable (разрядность должна совпадать с разрядностью Python). Можно скачать по ссылкам https://www.microsoft.com/en-us/download/details.aspx?id=40784 и https://www.microsoft.com/ru-ru/download/details.aspx?id=48145.

2. Установить зависимости для Python, запустив скрипт `rebuild_venv.bat`:

   ```
   rebuild_venv.bat
   ```

Если у вас возникла такая ошибка:

```
qt.qpa.plugin: Could not find the Qt platform plugin "windows" in "" 
This application failed to start because no Qt platform plugin could be initialized. Reinstalling the application may fix this problem.
```

выполните следующую команду в виртуальном окружении:

```
set QT_QPA_PLATFORM_PLUGIN_PATH=venv\Lib\site-packages\PyQt5\Qt\plugins\platforms
```

Для работы нужно установить драйвер `ivm.inf` из папки `release_templates\win64\driver`.

## Установка в Linux

1. Установить библиотеки для работы со звуком и для сборки пакетов Python:

   ```
   sudo apt-get install -y python3-dev libasound2-dev
   ```

2. Установить зависимости для Python, выполнив скрипт rebuild_venv.sh:

   ```
   bash rebuild_venv.sh
   ```

Если у вас возникла такая ошибка:

```
qt.qpa.plugin: Could not load the Qt platform plugin "xcb" in "" even though it was found.
```

выполните следующие команды:

```
export QT_DEBUG_PLUGINS=1
sudo apt-get install --reinstall libxcb-xinerama0
```

Также нужен доступ на hg.ximc.ru к репозиториям: epcore, ivviewer. Если при установке зависимостей через hg возникает ошибка авторизации, то нужно прописать в Hg логин и пароль от репозитория hg.ximc.ru. Это можно сделать через TortoiseHg, открыв любой репозиторий, перейдя во вкладку синхронизации (две стрелочки по кругу на верхней панели) и нажав на иконку с изображением замка (в середине страницы, слева от строки с адресом сервера). После этого нужно переоткрыть консоль.

Если при подключении вахометров они не обнаруживаются , то стоит прописать в системе VID и PID устройства для драйвера виртуального COM-порта. 
В Ubuntu это можно сделать так:

```
sudo sh -c 'echo 1CBC 0007 > /sys/bus/usb/drivers/cdc_acm/new_id'
```

Для корректной работы ПО с COM-портами пользователь должен находиться в группе dealout. Если при открытии устройств возникают какие-то проблемы, попробуйте запустить ПО с правами root.

## Запуск в Windows

ПО предоставляет возможность работать с устройствами IVM10 и ASA (Meridian) по отдельности.

#### Запуск приложения в Windows для работы с IVM10

Чтобы запустить приложение для работы с устройствами IVM10, нужно выполнить команду:

```
venv\Scripts\python main.py <ivm_url> [--ref <ivm_url>]
```
ПО может работать как с одним, так и с двумя устройствами (второе устройство задавать не обязательно). `ivm_url`  - это адрес COM-порта. Также `ivm_url` может быть `virtual` (будет использоваться виртуальный измеритель). Пример запуска:

```
venv\Scripts\python main.py com:\\.\COM13 --ref virtual
```

Для запуска ПО для работы с устройствами типа IVM10 можно использовать скрипт `run_real.bat`, в котором нужно прописать адреса COM-портов, к которым подключены устройства:

```
run_real.bat
```

#### Запуск приложения в Windows для работы с ASA

Чтобы запустить приложение для работы с сетевым вахометром ASA, нужно выполнить команду:

```
venv\Scripts\python main.py xmlrpc:172.16.3.213 --ref virtualasa --config eplab_asa_options.json
```

Здесь предполагается, что:

- сервер вахометра имеет IP адрес 172.16.3.213 и прослушивает порт 8888;
- совместно с вахометром ASA запускается виртуальный вахометр (за это отвечает аргумент `virtualasa`);
- ПО получает файл с конфигурацией `eplab_asa_options.json` для работы с вахометром ASA.

Для запуска ПО для работы с устройством ASA можно использовать скрипт `run_asa.bat`, в котором нужно прописать IP адрес сервера:

```
run_asa.bat
```

## Запуск в Linux

ПО предоставляет возможность работать с устройствами IVM10 и ASA (Meridian) по отдельности.

#### Запуск приложения в Linux для работы с IVM10

Чтобы запустить приложение для работы с устройствами IVM10, нужно выполнить команду:

```
venv/bin/python3 main.py <ivm_url> [--ref <ivm_url>]
```
ПО может работать как с одним, так и с двумя устройствами (второе устройство задавать не обязательно). `ivm_url`  - это адрес COM-порта. Также `ivm_url` может быть `virtual` (будет использоваться виртуальный измеритель). Пример запуска:

```
venv/bin/python3 main.py com:///dev/ttyACM0 --ref virtual
```

Для запуска ПО для работы с устройствами типа IVM10 можно использовать скрипт `run_real.sh`, в котором нужно прописать адреса COM-портов, к которым подключены устройства:

```
bash run_real.sh
```

#### Запуск приложения в Linux для работы с ASA

Чтобы запустить приложение для работы с сетевым вахометром ASA, нужно выполнить команду:

```
venv/bin/python3 main.py xmlrpc:172.16.3.213 --ref virtualasa --config eplab_asa_options.json
```

Здесь предполагается, что:

- сервер вахометра имеет IP адрес 172.16.3.213 и прослушивает порт 8888;
- совместно с вахометром ASA запускается виртуальный вахометр (за это отвечает аргумент `virtualasa`);
- ПО получает файл с конфигурацией `eplab_asa_options.json` для работы с вахометром ASA.

Для запуска ПО для работы с устройством ASA можно использовать скрипт `run_asa.sh`, в котором нужно прописать IP адрес сервера:

```
bash run_asa.sh
```

## Запуск тестов в Windows

Для запуска тестов нужно выполнить скрипт `testall.bat`:

```
testall.bat
```

## Запуск тестов в Linux

Для запуска тестов нужно выполнить скрипт `testall.sh`:

```
bash testall.sh
```

## Дополнительно

Файл платы для тестов можно загрузить из папки  `tests\test_data\eyepoint_calibration_board`.

Чтобы сконвертировать файлы плат, сделанные с помощью EyePoint Px, можно воспользоваться конвертером, который находится в модуле `epcore.utils`.

Для работы с ASA нужно запустить сервер версии 4.2.7.

